<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Moodette — Your Chic Edit</title>
  <style>
    :root{--bg:#faf9f8;--fg:#0f1720;--muted:#6b7280;--card:#fff;--shadow:0 6px 24px rgba(0,0,0,.06);--r:16px;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 72px}
    header{text-align:center;margin-bottom:8px} h1{margin:.2rem 0 0;font-size:42px}
    .lead{color:var(--muted);max-width:900px;margin:10px auto 18px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:8px 0}
    .chip{padding:8px 12px;border-radius:999px;background:#11182715;cursor:pointer}
    .chip[data-active="true"]{background:#111827;color:#fff}
    .search{width:min(520px,100%);border:1px solid #e5e7eb;border-radius:999px;padding:10px 14px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:420px){.grid{grid-template-columns:1fr}}
    .section{margin:28px 0 10px;display:flex;justify-content:space-between;align-items:center}
    .section h2{margin:0}
    .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:1/1;object-fit:cover;width:100%;background:#f3f4f6}
    .body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:600;font-size:14px;line-height:1.35}
    .muted{color:var(--muted);font-size:12px}
    .price{font-weight:700}
    .cta{margin-top:auto;text-decoration:none;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;text-align:center;font-weight:600}
    .empty{padding:28px 8px;color:var(--muted)}
    footer{margin-top:40px;text-align:center;color:var(--muted);font-size:12px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#11182710;padding:6px 10px;border-radius:999px}
    .sk{background:linear-gradient(90deg,#f4f4f5 25%,#ececec 37%,#f4f4f5 63%);background-size:400% 100%;animation:s 1.4s ease infinite;height:260px;border-radius:var(--r)}
    @keyframes s{0%{background-position:100% 0}100%{background-position:0 0}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Your Chic Edit</h1>
    <p class="lead">Curated Temu picks — updated automatically.</p>
    <div class="toolbar">
      <input id="q" class="search" placeholder="Поиск по товарам… (название, категория)"/>
    </div>
    <div id="chips" class="toolbar"></div>
    <div style="text-align:center;margin-top:6px"><span class="pill">Источник: <code id="src">/data/products.json</code></span></div>
  </header>

  <div id="content"></div>
  <div id="err" class="empty" style="display:none"></div>

  <footer>© <span id="y"></span> Moodette · Updated <span id="updated">—</span></footer>
</div>

<script>
const sources = [
  "/data/products.json",
  "https://raw.githubusercontent.com/tanylee/temu-lp-autofeed/main/data/products.json",
  "https://cdn.jsdelivr.net/gh/tanylee/temu-lp-autofeed@main/data/products.json"
];

const BAD_URL = /(download-temu\.html|play\.google\.com|apps\.apple\.com|itunes\.apple\.com)/i;

const state = { data:null, view:"all", q:"" };

const el = id => document.getElementById(id);

function fmtPrice(n){
  if(n==null||n==="") return "";
  const x = typeof n==="string" ? Number(n.replace(/[^\d.]/g,"")) : Number(n);
  if(!isFinite(x)) return "";
  try { return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(x); }
  catch { return "$"+x.toFixed(2); }
}

function unique(arr, key){const s=new Set(),o=[];for(const it of arr){const k=key(it);if(!s.has(k)){s.add(k);o.push(it)}}return o;}

async function fetchWithFallback(urls){
  for(const u of urls){
    try{
      const r = await fetch(u, {cache:"no-store"});
      if(r.ok){ el("src").textContent = u; return r.json(); }
    }catch{}
  }
  throw new Error("Не удалось загрузить фид из всех источников");
}

/* НОРМАЛИЗАТОР:
  поддерживает:
  1) {categories:[{name,items:[{id|product_id, title|name, image|main_image|images[0], productUrl|link_out|url, price, category}]}]}
  2) плоский массив объектов с теми же полями
*/
function normalize(raw){
  const toItem = (x, fallbackCat="Misc")=>{
    const id = x.id || x.product_id || x.sku || x.goods_id || x.url || x.link_out || Math.random().toString(36).slice(2);
    const title = x.title || x.name || "";
    const img = x.image || x.main_image || (Array.isArray(x.images)&&x.images[0]) || "";
    let url = x.productUrl || x.link_out || x.url || "";
    if(BAD_URL.test(url) && x.link_out) url = x.link_out;
    const price = (x.price!=null)? x.price : (x.price_text || "");
    const category = x.category || fallbackCat;
    return { id:String(id), title, image:img, url, price, category, description:x.description||"" };
  };

  // вариант 1: уже с категориями
  if(raw && Array.isArray(raw.categories)){
    const cats = [];
    for(const c of raw.categories){
      const name = String(c?.name ?? "Misc");
      const arr = Array.isArray(c?.items)? c.items : [];
      const items = unique(arr.map(i=>toItem(i, name)).filter(i=>i.title && i.image && i.url && !BAD_URL.test(i.url)), it=>it.id);
      if(items.length) cats.push({name, items});
    }
    return { generatedAt: raw.generatedAt || new Date().toISOString(), categories: cats };
  }

  // вариант 2: плоский массив
  if(Array.isArray(raw)){
    // попробуем угадать категории; если их нет — всё в Misc
    const groups = new Map();
    for(const x of raw){
      const cat = x.category || "Misc";
      if(!groups.has(cat)) groups.set(cat, []);
      groups.get(cat).push(toItem(x, cat));
    }
    const cats = [];
    for(const [name,itemsRaw] of groups.entries()){
      const items = unique(itemsRaw.filter(i=>i.title && i.image && i.url && !BAD_URL.test(i.url)), it=>it.id);
      if(items.length) cats.push({name, items});
    }
    return { generatedAt: new Date().toISOString(), categories: cats };
  }

  // неизвестный формат
  return { generatedAt: new Date().toISOString(), categories: [] };
}

function buildChips(cats){
  const host = el("chips"); host.innerHTML="";
  const mk = (name,label=name)=>{const d=document.createElement("div");d.className="chip";d.textContent=label;d.dataset.active=(state.view===name);d.onclick=(()=>{state.view=name; buildChips(cats); render();});return d;}
  host.appendChild(mk("all","all"));
  for(const c of cats) host.appendChild(mk(c.name));
}

function render(){
  const mount = el("content"); const err = el("err");
  err.style.display="none"; mount.innerHTML="";
  if(!state.data) return;

  const cats = state.data.categories || [];
  const show = state.view==="all" ? cats : cats.filter(c=>c.name===state.view);
  const term = state.q.trim().toLowerCase();

  for(const cat of show){
    const items = (Array.isArray(cat.items)?cat.items:[]).filter(x=>{
      const hay = `${x.title||""} ${cat.name||""}`.toLowerCase();
      return !term || hay.includes(term);
    });
    if(!items.length) continue;

    const sec = document.createElement("section");
    sec.className="section";
    sec.innerHTML = `<h2>${cat.name}</h2><div style="color:#6b7280">${items.length} items</div>`;
    mount.appendChild(sec);

    const grid = document.createElement("div"); grid.className="grid"; mount.appendChild(grid);

    for(const it of items){
      const a = document.createElement("article"); a.className="card";
      a.innerHTML = `
        <img class="thumb" loading="lazy" src="${it.image||""}" alt="${(it.title||"").replace(/"/g,"&quot;")}">
        <div class="body">
          <div class="title">${it.title||"—"}</div>
          <div class="muted">${it.description? it.description : ""}</div>
          <div class="price">${fmtPrice(it.price)}</div>
          <a class="cta" href="${it.url||"#"}" target="_blank" rel="noopener">Shop on Temu</a>
        </div>`;
      grid.appendChild(a);
    }
  }

  if(!mount.children.length){
    const e = document.createElement("div"); e.className="empty"; e.textContent="Ничего не найдено";
    mount.appendChild(e);
  }
}

async function init(){
  const content = el("content");
  const sk = document.createElement("div"); sk.className="grid";
  for(let i=0;i<8;i++) sk.appendChild(Object.assign(document.createElement("div"),{className:"sk"}));
  content.appendChild(sk);

  try{
    const raw = await fetchWithFallback(sources);
    const data = normalize(raw);
    state.data = data;
    el("y").textContent = new Date().getFullYear();
    el("updated").textContent = new Date(data.generatedAt).toLocaleString();
    buildChips(data.categories||[]);
    render();
  }catch(e){
    el("err").style.display="block"; el("err").textContent="Ошибка загрузки фида. Откройте консоль (F12) → Console.";
    console.error(e);
  }
}

el("q").addEventListener("input", e=>{ state.q = e.target.value || ""; render(); });

init();
</script>
</body>
</html>

<script>
(async function () {
  const FEED = "/data/products.json";

  const $root = document.querySelector("#root");
  const $search = document.querySelector("#search");
  const $tabs = document.querySelector("#tabs");
  const $src = document.querySelector("#feed-src");
  $src.textContent = FEED;

  let feed = { categories: [] };
  try {
    const r = await fetch(FEED, { cache: "no-store" });
    feed = await r.json();
  } catch (e) {
    $root.innerHTML = `<p style="opacity:.6">Не удалось загрузить фид</p>`;
    return;
  }

  const allCats = feed.categories.map(c => c.name);
  renderTabs(["all", ...allCats]);

  function normalizeItems(catName) {
    if (catName === "all") {
      return feed.categories.flatMap(c => c.items || []);
    }
    const c = feed.categories.find(x => x.name.toLowerCase() === catName.toLowerCase());
    return c ? (c.items || []) : [];
  }

  function renderTabs(names) {
    $tabs.innerHTML = "";
    names.forEach(name => {
      const btn = document.createElement("button");
      btn.className = "chip";
      btn.dataset.cat = name;
      btn.textContent = name;
      $tabs.appendChild(btn);
    });
    $tabs.querySelector('button[data-cat="all"]').classList.add("chip--active");
  }

  function priceStr(v) {
    if (v === null || v === undefined || v === "") return "";
    const n = Number(v);
    return isFinite(n) ? `$${n.toFixed(2)}` : String(v);
  }

  // ⬇️ карточка: кликаем по item.link_out (партнёрка), данные берём из item.url (view_url)
  function cardHTML(item) {
    const img = item.main_image || (item.images && item.images[0]) || "";
    const ttl = (item.title || "").slice(0, 120);
    const p   = priceStr(item.price);
    const out = item.link_out || item.url;  // клик = партнёрка
    return `
      <article class="card">
        <a class="card__img" href="${out}" target="_blank" rel="nofollow noopener">
          <img loading="lazy" src="${img}" alt="">
        </a>
        <div class="card__body">
          <a class="card__title" href="${out}" target="_blank" rel="nofollow noopener">${ttl || "View on Temu"}</a>
          <div class="card__meta">
            ${p ? `<span class="price">${p}</span>` : `<span class="price muted">See price on Temu</span>`}
          </div>
        </div>
      </article>
    `;
  }

  function render(cat = "all", query = "") {
    const items = normalizeItems(cat)
      .filter(it => it && (it.title || it.product_id))
      .filter(it => {
        if (!query) return true;
        const q = query.toLowerCase();
        return (it.title || "").toLowerCase().includes(q) ||
               (it.category || "").toLowerCase().includes(q);
      });

    if (items.length === 0) {
      $root.innerHTML = `<p style="opacity:.6">Ничего не найдено</p>`;
      return;
    }
    $root.innerHTML = items.map(cardHTML).join("");
  }

  // интерактив
  $tabs.addEventListener("click", (e) => {
    const b = e.target.closest("button[data-cat]");
    if (!b) return;
    [...$tabs.children].forEach(x => x.classList.remove("chip--active"));
    b.classList.add("chip--active");
    render(b.dataset.cat, $search.value.trim());
  });

  $search.addEventListener("input", () => {
    const active = $tabs.querySelector(".chip--active")?.dataset.cat || "all";
    render(active, $search.value.trim());
  });

  // первая отрисовка
  render("all", "");
})();
</script>
